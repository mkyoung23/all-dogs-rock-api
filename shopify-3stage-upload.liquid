{% comment %}
  ALL DOGS ROCK - 3 STAGE DOG PHOTO SYSTEM
  Stage 1: Upload dog photos (multiple angles)
  Stage 2: Choose template (Washington Crossing Delaware only for now)
  Stage 3: AI generates customer's dog in that pose
{% endcomment %}

<style>
  .stage-container {
    max-width: 900px;
    margin: 0 auto;
    padding: 40px 20px;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  }

  .stage {
    display: none;
  }

  .stage.active {
    display: block;
  }

  .stage-header {
    text-align: center;
    padding: 40px 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 20px;
    color: white;
    margin-bottom: 40px;
  }

  .stage-header h1 {
    font-size: 2.5em;
    margin-bottom: 10px;
  }

  .stage-header p {
    font-size: 1.2em;
    opacity: 0.95;
  }

  .upload-zone {
    border: 3px dashed #667eea;
    border-radius: 15px;
    padding: 60px 20px;
    text-align: center;
    background: #f8f9ff;
    margin-bottom: 20px;
    cursor: pointer;
    transition: all 0.3s;
  }

  .upload-zone:hover {
    border-color: #764ba2;
    background: #f0f2ff;
  }

  .upload-zone.has-images {
    border-style: solid;
    border-color: #28a745;
  }

  .photo-previews {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 20px;
    margin: 20px 0;
  }

  .photo-preview {
    position: relative;
    border-radius: 10px;
    overflow: hidden;
  }

  .photo-preview img {
    width: 100%;
    height: 200px;
    object-fit: cover;
  }

  .remove-photo {
    position: absolute;
    top: 10px;
    right: 10px;
    background: #dc3545;
    color: white;
    border: none;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    cursor: pointer;
    font-weight: bold;
  }

  .btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 18px 50px;
    border-radius: 50px;
    font-size: 1.2em;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s;
    display: block;
    margin: 30px auto;
  }

  .btn-primary:hover {
    transform: scale(1.05);
    box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
  }

  .btn-primary:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .template-card {
    background: white;
    border-radius: 15px;
    padding: 30px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    text-align: center;
  }

  .template-image {
    width: 100%;
    max-width: 400px;
    height: 400px;
    object-fit: cover;
    border-radius: 10px;
    margin-bottom: 20px;
  }

  .template-card h2 {
    font-size: 2em;
    margin-bottom: 15px;
    color: #333;
  }

  .template-card p {
    color: #666;
    font-size: 1.1em;
    margin-bottom: 25px;
  }

  .loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.9);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 9999;
  }

  .loading-overlay.active {
    display: flex;
  }

  .loading-content {
    background: white;
    padding: 50px;
    border-radius: 20px;
    text-align: center;
    max-width: 500px;
  }

  .spinner {
    border: 6px solid #f3f3f3;
    border-top: 6px solid #667eea;
    border-radius: 50%;
    width: 60px;
    height: 60px;
    animation: spin 1s linear infinite;
    margin: 0 auto 20px;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .result-container {
    text-align: center;
  }

  .result-image {
    max-width: 100%;
    border-radius: 15px;
    margin: 20px 0;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
  }

  .btn-secondary {
    background: #6c757d;
    color: white;
    border: none;
    padding: 15px 40px;
    border-radius: 50px;
    font-size: 1.1em;
    font-weight: 600;
    cursor: pointer;
    margin: 10px;
  }

  .btn-success {
    background: #28a745;
    color: white;
    border: none;
    padding: 18px 50px;
    border-radius: 50px;
    font-size: 1.2em;
    font-weight: 700;
    cursor: pointer;
    margin: 10px;
  }
</style>

<div class="stage-container">
  <!-- STAGE 1: Upload Dog Photos -->
  <div id="stage1" class="stage active">
    <div class="stage-header">
      <h1>üêï Step 1: Upload Your Dog's Photos</h1>
      <p>Upload 1-3 photos of your dog from different angles so we can capture their features perfectly</p>
    </div>

    <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
      <div style="font-size: 4em; margin-bottom: 20px;">üì∑</div>
      <p style="font-size: 1.3em; margin-bottom: 10px;">Click to upload or drag & drop</p>
      <p style="color: #666;">JPG or PNG ‚Ä¢ Max 10MB per photo ‚Ä¢ 1-3 photos recommended</p>
    </div>

    <input type="file" id="fileInput" multiple accept="image/jpeg,image/png,image/jpg" style="display: none;" onchange="handleFileUpload(event)">

    <div id="photoPreviews" class="photo-previews"></div>

    <button class="btn-primary" id="continueBtn1" onclick="goToStage2()" disabled>
      Continue to Choose Template ‚Üí
    </button>
  </div>

  <!-- STAGE 2: Choose Template -->
  <div id="stage2" class="stage">
    <div class="stage-header">
      <h1>üé® Step 2: Choose Your Iconic Pose</h1>
      <p>Select which famous image you want your dog in</p>
    </div>

    <div class="template-card">
      <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/9/95/Washington_Crossing_the_Delaware_by_Emanuel_Leutze%2C_MMA-NYC%2C_1851.jpg/500px-Washington_Crossing_the_Delaware_by_Emanuel_Leutze%2C_MMA-NYC%2C_1851.jpg"
           alt="Washington Crossing Delaware Template"
           class="template-image">
      <h2>Washington Crossing the Delaware</h2>
      <p>Your dog as General Washington, heroically leading troops across the icy Delaware River in this iconic Revolutionary War scene!</p>
      <button class="btn-primary" onclick="goToStage3()">
        Transform My Dog into Washington! ‚Üí
      </button>
    </div>

    <button class="btn-secondary" onclick="goToStage1()">‚Üê Back to Upload Photos</button>
  </div>

  <!-- STAGE 3: Generating & Result -->
  <div id="stage3" class="stage">
    <div class="stage-header">
      <h1>‚ú® Step 3: Your Iconic Dog is Ready!</h1>
      <p>Here's your dog transformed into an icon</p>
    </div>

    <div class="result-container" id="resultContainer">
      <img id="resultImage" class="result-image" alt="Your iconic dog">
      <div style="margin-top: 30px;">
        <button class="btn-success" onclick="addToCart()">Add to Cart & Shop Now! ‚Üí</button>
        <button class="btn-secondary" onclick="startOver()">‚Üê Start Over</button>
      </div>
    </div>
  </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay">
  <div class="loading-content">
    <div class="spinner"></div>
    <h2 style="margin-bottom: 15px;">üé® Creating Your Masterpiece...</h2>
    <p id="loadingText">Analyzing your dog's features...</p>
    <p style="color: #666; margin-top: 10px;">This takes about 10-15 seconds</p>
  </div>
</div>

<script>
  const API_BASE = 'https://all-dogs-rock-api-v2.vercel.app';
  let uploadedPhotos = [];
  let selectedTemplate = 'washington-crossing';
  let finalImageUrl = '';

  // Handle file upload
  function handleFileUpload(event) {
    const files = Array.from(event.target.files);

    files.forEach(file => {
      if (uploadedPhotos.length >= 3) {
        alert('Maximum 3 photos allowed');
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        uploadedPhotos.push({
          data: e.target.result,
          name: file.name
        });
        displayPreviews();
        updateContinueButton();
      };
      reader.readAsDataURL(file);
    });

    document.getElementById('uploadZone').classList.add('has-images');
  }

  // Display photo previews
  function displayPreviews() {
    const container = document.getElementById('photoPreviews');
    container.innerHTML = '';

    uploadedPhotos.forEach((photo, index) => {
      const div = document.createElement('div');
      div.className = 'photo-preview';
      div.innerHTML = `
        <img src="${photo.data}" alt="Dog photo ${index + 1}">
        <button class="remove-photo" onclick="removePhoto(${index})">√ó</button>
      `;
      container.appendChild(div);
    });
  }

  // Remove photo
  function removePhoto(index) {
    uploadedPhotos.splice(index, 1);
    displayPreviews();
    updateContinueButton();

    if (uploadedPhotos.length === 0) {
      document.getElementById('uploadZone').classList.remove('has-images');
    }
  }

  // Update continue button
  function updateContinueButton() {
    const btn = document.getElementById('continueBtn1');
    btn.disabled = uploadedPhotos.length === 0;
  }

  // Navigation functions
  function goToStage1() {
    showStage('stage1');
  }

  function goToStage2() {
    if (uploadedPhotos.length === 0) {
      alert('Please upload at least one photo of your dog');
      return;
    }
    showStage('stage2');
  }

  async function goToStage3() {
    showLoading(true);
    updateLoadingText('Analyzing your dog\'s unique features...');

    try {
      // Use the first uploaded photo as the primary reference
      const primaryPhoto = uploadedPhotos[0].data;

      updateLoadingText('Placing your dog into the iconic scene...');

      // Call generation API
      const response = await fetch(`${API_BASE}/api/app-proxy/generate`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          dogPhoto: primaryPhoto,
          poseId: 'washington-crossing'
        })
      });

      const data = await response.json();

      showLoading(false);

      if (data.success) {
        finalImageUrl = Array.isArray(data.imageUrl) ? data.imageUrl[0] : data.imageUrl;
        document.getElementById('resultImage').src = finalImageUrl;
        showStage('stage3');
      } else {
        alert('Generation failed: ' + (data.error || 'Unknown error'));
      }
    } catch (error) {
      showLoading(false);
      console.error('Error:', error);
      alert('Failed to generate image. Please try again!');
    }
  }

  function showStage(stageId) {
    document.querySelectorAll('.stage').forEach(stage => {
      stage.classList.remove('active');
    });
    document.getElementById(stageId).classList.add('active');
    window.scrollTo(0, 0);
  }

  function showLoading(show) {
    const overlay = document.getElementById('loadingOverlay');
    if (show) {
      overlay.classList.add('active');
    } else {
      overlay.classList.remove('active');
    }
  }

  function updateLoadingText(text) {
    document.getElementById('loadingText').textContent = text;
  }

  function addToCart() {
    // Redirect to product page with custom image
    window.location.href = `/products/custom-washington-dog?image=${encodeURIComponent(finalImageUrl)}`;
  }

  function startOver() {
    uploadedPhotos = [];
    finalImageUrl = '';
    document.getElementById('uploadZone').classList.remove('has-images');
    displayPreviews();
    updateContinueButton();
    goToStage1();
  }

  // Drag and drop support
  const uploadZone = document.getElementById('uploadZone');

  uploadZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadZone.style.borderColor = '#764ba2';
  });

  uploadZone.addEventListener('dragleave', () => {
    uploadZone.style.borderColor = '#667eea';
  });

  uploadZone.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadZone.style.borderColor = '#667eea';

    const files = Array.from(e.dataTransfer.files);
    const imageFiles = files.filter(f => f.type.startsWith('image/'));

    if (imageFiles.length > 0) {
      document.getElementById('fileInput').files = e.dataTransfer.files;
      handleFileUpload({ target: { files: imageFiles } });
    }
  });
</script>
