/**
 * Vercel Serverless Function: Set Home Page
 * Updates the Shopify theme to use a custom page as the home page
 */

export const config = {
  runtime: 'nodejs',
  maxDuration: 60
};

// Shopify Admin API Configuration
const SHOPIFY_STORE_DOMAIN = process.env.SHOPIFY_STORE_DOMAIN;
const SHOPIFY_ACCESS_TOKEN = process.env.SHOPIFY_SECRET_KEY;
const API_VERSION = '2024-10';

/**
 * Make a request to Shopify REST Admin API
 */
async function shopifyRequest(method, endpoint, body = null) {
  const url = `https://${SHOPIFY_STORE_DOMAIN}/admin/api/${API_VERSION}${endpoint}`;

  const options = {
    method,
    headers: {
      'X-Shopify-Access-Token': SHOPIFY_ACCESS_TOKEN,
      'Content-Type': 'application/json',
    }
  };

  if (body) {
    options.body = JSON.stringify(body);
  }

  const response = await fetch(url, options);

  if (!response.ok) {
    const errorText = await response.text();
    throw new Error(`Shopify API error (${response.status}): ${errorText}`);
  }

  return await response.json();
}

/**
 * Get the active theme
 */
async function getActiveTheme() {
  const data = await shopifyRequest('GET', '/themes.json');
  const activeTheme = data.themes.find(theme => theme.role === 'main');

  if (!activeTheme) {
    throw new Error('No active theme found');
  }

  return activeTheme;
}

/**
 * Get a theme asset
 */
async function getThemeAsset(themeId, assetKey) {
  const data = await shopifyRequest('GET', `/themes/${themeId}/assets.json?asset[key]=${encodeURIComponent(assetKey)}`);
  return data.asset;
}

/**
 * Update a theme asset
 */
async function updateThemeAsset(themeId, assetKey, value) {
  await shopifyRequest('PUT', `/themes/${themeId}/assets.json`, {
    asset: {
      key: assetKey,
      value: value
    }
  });
}

/**
 * Main handler
 */
export default async function handler(req, res) {
  const log = [];

  try {
    log.push('üè† Setting Home Page...');
    log.push('');

    // Get the active theme
    log.push('üé® Step 1: Getting active theme...');
    const theme = await getActiveTheme();
    log.push(`‚úÖ Found theme: ${theme.name} (ID: ${theme.id})`);
    log.push('');

    // Get the current index.liquid template
    log.push('üìÑ Step 2: Fetching current home page template...');
    const indexAsset = await getThemeAsset(theme.id, 'templates/index.liquid');
    log.push(`‚úÖ Current template size: ${indexAsset.value?.length || 0} characters`);
    log.push('');

    // Create a new index.liquid that redirects to our custom page
    log.push('‚úèÔ∏è  Step 3: Creating new home page template...');
    const newIndexTemplate = `{%- comment -%}
  Custom Home Page - Redirects to Welcome Page
  Auto-generated by All Dogs Rock API
{%- endcomment -%}

<script>
  // Redirect to the custom welcome page
  window.location.href = '/pages/welcome';
</script>

{%- comment -%}
  Fallback for browsers with JavaScript disabled
{%- endcomment -%}
<noscript>
  <meta http-equiv="refresh" content="0; url=/pages/welcome">
</noscript>

<div style="text-align: center; padding: 50px; font-family: Arial, sans-serif;">
  <h1>Redirecting to All Dogs Rock...</h1>
  <p>If you are not redirected automatically, <a href="/pages/welcome">click here</a>.</p>
</div>
`;

    await updateThemeAsset(theme.id, 'templates/index.liquid', newIndexTemplate);
    log.push('‚úÖ Updated index.liquid template');
    log.push('');

    log.push('=' .repeat(80));
    log.push('‚úÖ HOME PAGE SET SUCCESSFULLY!');
    log.push('');
    log.push('Your store home page now redirects to:');
    log.push('   https://alldogsrockshop.com/pages/welcome');
    log.push('');
    log.push('Visit your store to see it in action:');
    log.push('   https://alldogsrockshop.com');
    log.push('=' .repeat(80));

    return res.status(200).json({
      success: true,
      message: 'Home page set successfully',
      homePageUrl: 'https://alldogsrockshop.com/pages/welcome',
      storeUrl: 'https://alldogsrockshop.com',
      theme: {
        id: theme.id,
        name: theme.name
      },
      log: log
    });

  } catch (error) {
    log.push('');
    log.push('‚ùå ERROR: ' + error.message);

    return res.status(500).json({
      success: false,
      error: error.message,
      log: log
    });
  }
}
