<!--
  COMPLETE WORKING SHOPIFY PAGE
  Paste this entire code into Shopify Pages > Create New Page > Show HTML

  WHAT THIS DOES:
  1. Customer uploads their dog photo
  2. Customer enters dog name
  3. Customer selects iconic pose (Mona Lisa, etc.)
  4. AI generates their dog in that pose
  5. Customer selects product (t-shirt, canvas, etc.)
  6. Adds to cart with custom image URL
  7. Customer checks out through Shopify

  IMPORTANT: Set the correct product variant IDs below!
-->

<style>
  .iconic-dogs-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 40px 20px;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  }

  .hero-section {
    text-align: center;
    margin-bottom: 60px;
    padding: 60px 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 20px;
    color: white;
  }

  .hero-section h1 {
    font-size: 3.5em;
    margin-bottom: 20px;
    font-weight: 800;
  }

  .upload-section {
    background: white;
    padding: 40px;
    border-radius: 15px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    margin-bottom: 60px;
    text-align: center;
  }

  .upload-btn {
    font-size: 1.2em;
    padding: 15px 40px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 50px;
    cursor: pointer;
    font-weight: 700;
  }

  .upload-btn:hover {
    transform: scale(1.05);
  }

  #preview {
    max-width: 300px;
    border-radius: 15px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.2);
    margin: 20px auto;
    display: block;
  }

  .poses-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 30px;
    margin-bottom: 40px;
  }

  .pose-card {
    background: white;
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    transition: all 0.3s;
    cursor: pointer;
  }

  .pose-card:hover {
    transform: translateY(-10px);
    box-shadow: 0 15px 40px rgba(0,0,0,0.2);
  }

  .modal {
    display: none;
    position: fixed;
    z-index: 9999;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.8);
  }

  .modal-content {
    background: white;
    margin: 5% auto;
    padding: 40px;
    border-radius: 20px;
    max-width: 600px;
    text-align: center;
  }

  .spinner {
    border: 5px solid #f3f3f3;
    border-top: 5px solid #667eea;
    border-radius: 50%;
    width: 60px;
    height: 60px;
    animation: spin 1s linear infinite;
    margin: 20px auto;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .product-card {
    background: white;
    border: 3px solid #eee;
    border-radius: 15px;
    padding: 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
  }

  .product-card:hover {
    border-color: #667eea;
    transform: translateY(-5px);
  }

  .product-card.selected {
    border-color: #667eea;
    background: #f8f9ff;
  }

  .btn-primary {
    padding: 15px 40px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 50px;
    font-size: 1.2em;
    font-weight: 700;
    cursor: pointer;
    margin: 20px 10px;
  }

  .btn-primary:hover {
    transform: scale(1.05);
  }

  .btn-secondary {
    padding: 12px 30px;
    background: #666;
    color: white;
    border: none;
    border-radius: 25px;
    cursor: pointer;
    margin: 10px;
  }
</style>

<div class="iconic-dogs-container">
  <div class="hero-section">
    <h1>üêï Create Your Iconic Dog üé®</h1>
    <p>Transform your dog into legendary moments! Upload your dog's photo and put them in iconic poses!</p>
  </div>

  <div class="upload-section">
    <h2>üì∏ Upload Your Dog's Photo</h2>
    <p style="color: #666; margin-bottom: 20px;">We'll use YOUR dog in the iconic pose!</p>
    <input type="file" id="dogPhoto" accept="image/*" style="display: none;">
    <button class="upload-btn" onclick="document.getElementById('dogPhoto').click()">Choose Photo</button>
    <div id="previewSection" style="display: none;">
      <img id="preview" alt="Your dog">
      <p style="color: #667eea; font-weight: 600; margin-top: 10px;">‚úÖ Photo uploaded!</p>
    </div>
    <p id="uploadPrompt" style="margin-top: 15px; color: #999;">No photo selected</p>

    <div style="margin-top: 30px;">
      <label for="dogName" style="display: block; font-size: 1.2em; font-weight: 600; margin-bottom: 10px;">
        üêæ Your Dog's Name (Optional)
      </label>
      <input type="text" id="dogName" placeholder="Enter your dog's name"
        style="font-size: 1.1em; padding: 12px 20px; border: 3px solid #667eea; border-radius: 50px; width: 300px; max-width: 100%; text-align: center;">
    </div>
  </div>

  <div id="posesGrid" class="poses-grid">
    <p style="text-align: center; color: #999;">Loading poses...</p>
  </div>
</div>

<!-- Generation Modal -->
<div id="modal" class="modal">
  <div class="modal-content">
    <h2 id="modalTitle">Generating Your Iconic Dog...</h2>
    <div id="loadingSection">
      <div class="spinner"></div>
      <p style="font-size: 1.2em; color: #667eea; margin: 20px 0;">Creating your masterpiece! üé®</p>
    </div>
    <div id="resultSection" style="display: none;">
      <img id="resultImage" style="max-width: 100%; border-radius: 15px; margin: 20px 0;" alt="Your iconic dog">
      <div id="productsSection">
        <h3 style="margin-top: 30px;">Choose Your Product:</h3>
        <div id="productsGrid" class="poses-grid" style="margin-top: 20px;"></div>
      </div>
      <div id="cartSection" style="display: none; margin-top: 30px;">
        <h3>Adding to Cart...</h3>
        <div class="spinner"></div>
      </div>
      <button class="btn-secondary" onclick="closeModal()">Close</button>
    </div>
  </div>
</div>

<script>
  const API_BASE = 'https://all-dogs-rock-api-v2.vercel.app';
  let dogPhotoBase64 = null;
  let currentImageUrl = null;
  let currentPoseName = null;

  // IMPORTANT: Update these with your actual Shopify product variant IDs
  const PRODUCTS = [
    {
      id: 'blanket',
      name: 'Custom Pet Portrait Blanket',
      variantId: 15579600257105,  // UPDATE THIS
      price: '$26.48',
      image: 'https://cdn.shopify.com/s/files/1/0690/6763/6817/files/4716419034030618402_2048.jpg'
    },
    {
      id: 'phone-case',
      name: 'Custom Pet Portrait Phone Case',
      variantId: 15579599929425,  // UPDATE THIS
      price: '$25.24',
      image: 'https://cdn.shopify.com/s/files/1/0690/6763/6817/files/f9a726aa-8118-4a9d-be8c-528d867d3cee.webp'
    },
    {
      id: 'canvas',
      name: 'Custom Pet Portrait Canvas',
      variantId: 15579598913617,  // UPDATE THIS
      price: '$27.50',
      image: 'https://cdn.shopify.com/s/files/1/0690/6763/6817/files/no-make-him-actually-look-like-hes-jumping-form-the-3-point-line-in-the-air-towards-the-basketball-and-going-to-dunk-it.png'
    },
    {
      id: 'tshirt',
      name: 'Custom Pet Portrait T-Shirt',
      variantId: 7855615672401,  // UPDATE THIS
      price: '$29.99',
      image: 'https://cdn.shopify.com/s/files/1/0690/6763/6817/files/michael_jackson_570b2a09-58dd-4ece-8cdf-a7fd883c72c4.jpg'
    }
  ];

  // File upload handler
  document.getElementById('dogPhoto').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(event) {
      dogPhotoBase64 = event.target.result;
      document.getElementById('preview').src = event.target.result;
      document.getElementById('previewSection').style.display = 'block';
      document.getElementById('uploadPrompt').textContent = 'Photo ready! Select an iconic pose below.';
    };
    reader.readAsDataURL(file);
  });

  // Load poses
  async function loadPoses() {
    try {
      const response = await fetch(API_BASE + '/api/poses/list');
      const data = await response.json();

      const grid = document.getElementById('posesGrid');
      grid.innerHTML = '';

      data.poses.forEach(pose => {
        const card = document.createElement('div');
        card.className = 'pose-card';
        card.onclick = () => generateImage(pose);
        card.innerHTML = `
          <img src="${API_BASE}${pose.templateUrl}" alt="${pose.name}"
               style="width: 100%; height: 200px; object-fit: cover;">
          <div style="padding: 20px;">
            <h3 style="margin-bottom: 10px;">${pose.name}</h3>
            <p style="color: #666; font-size: 0.9em;">${pose.description}</p>
            <button class="upload-btn" style="margin-top: 15px; width: 100%;">
              Create This Pose
            </button>
          </div>
        `;
        grid.appendChild(card);
      });
    } catch (error) {
      console.error('Error loading poses:', error);
    }
  }

  // Generate image
  async function generateImage(pose) {
    if (!dogPhotoBase64) {
      alert('Please upload a photo of your dog first!');
      return;
    }

    const dogName = document.getElementById('dogName').value;

    // Show modal
    document.getElementById('modal').style.display = 'block';
    document.getElementById('loadingSection').style.display = 'block';
    document.getElementById('resultSection').style.display = 'none';
    document.getElementById('modalTitle').textContent = `Generating ${pose.name}...`;

    try {
      const response = await fetch(API_BASE + '/api/app-proxy/generate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          poseId: pose.id,
          dogPhoto: dogPhotoBase64
        })
      });

      if (!response.ok) {
        throw new Error('Generation failed');
      }

      const data = await response.json();

      currentImageUrl = data.imageUrl;
      currentPoseName = pose.name;

      // Show result
      document.getElementById('loadingSection').style.display = 'none';
      document.getElementById('resultSection').style.display = 'block';
      document.getElementById('resultImage').src = data.imageUrl;
      document.getElementById('modalTitle').textContent = 'Your Iconic Dog is Ready! üéâ';

      // Load products
      loadProducts(dogName);

    } catch (error) {
      alert('Error generating image. Please try again.');
      console.error(error);
      closeModal();
    }
  }

  // Load products for selection
  function loadProducts(dogName) {
    const grid = document.getElementById('productsGrid');
    grid.innerHTML = '';

    PRODUCTS.forEach(product => {
      const card = document.createElement('div');
      card.className = 'product-card';
      card.innerHTML = `
        <img src="${product.image}" style="width: 100%; height: 150px; object-fit: cover; border-radius: 10px;">
        <h4 style="margin: 15px 0 10px;">${product.name}</h4>
        <p style="font-size: 1.3em; color: #667eea; font-weight: 700;">${product.price}</p>
        <button class="btn-primary" onclick="addToCart(${product.variantId}, '${product.name}', '${dogName}')">
          Add to Cart
        </button>
      `;
      grid.appendChild(card);
    });
  }

  // Add to Shopify cart via Ajax
  async function addToCart(variantId, productName, dogName) {
    document.getElementById('productsSection').style.display = 'none';
    document.getElementById('cartSection').style.display = 'block';

    const properties = {
      '_Custom Image URL': currentImageUrl,
      '_Iconic Pose': currentPoseName
    };

    if (dogName) {
      properties['_Dog Name'] = dogName;
    }

    try {
      const response = await fetch('/cart/add.js', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          items: [{
            id: variantId,
            quantity: 1,
            properties: properties
          }]
        })
      });

      if (!response.ok) {
        throw new Error('Failed to add to cart');
      }

      // Redirect to cart
      window.location.href = '/cart';

    } catch (error) {
      alert('Error adding to cart. Please try again.');
      console.error(error);
      document.getElementById('productsSection').style.display = 'block';
      document.getElementById('cartSection').style.display = 'none';
    }
  }

  function closeModal() {
    document.getElementById('modal').style.display = 'none';
  }

  // Initialize
  loadPoses();
</script>
