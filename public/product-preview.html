<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Preview Your Iconic Dog on Products</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: #f5f5f5;
    padding: 20px;
  }

  .container {
    max-width: 1200px;
    margin: 0 auto;
    background: white;
    border-radius: 20px;
    padding: 40px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.1);
  }

  .header {
    text-align: center;
    margin-bottom: 40px;
  }

  .header h1 {
    font-size: 2.5em;
    margin-bottom: 10px;
    color: #333;
  }

  .your-image-section {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding: 30px;
    border-radius: 15px;
    text-align: center;
    margin-bottom: 40px;
    color: white;
  }

  #yourImage {
    max-width: 300px;
    max-height: 300px;
    border-radius: 15px;
    margin: 20px auto;
    display: block;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
  }

  .products-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 30px;
    margin-bottom: 40px;
  }

  .product-card {
    background: white;
    border: 3px solid #eee;
    border-radius: 15px;
    padding: 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
  }

  .product-card:hover {
    border-color: #667eea;
    transform: translateY(-5px);
    box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
  }

  .product-card.selected {
    border-color: #667eea;
    background: #f8f9ff;
  }

  .product-name {
    font-size: 1.1em;
    font-weight: 700;
    margin-bottom: 10px;
    color: #333;
  }

  .product-price {
    font-size: 1.3em;
    color: #667eea;
    font-weight: 700;
    margin-bottom: 15px;
  }

  .select-btn {
    width: 100%;
    padding: 12px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 10px;
    font-size: 1em;
    font-weight: 700;
    cursor: pointer;
  }

  .preview-section {
    display: none;
    background: #f8f9ff;
    padding: 30px;
    border-radius: 15px;
    margin-bottom: 30px;
  }

  .preview-section.active {
    display: block;
  }

  .mockup-preview {
    text-align: center;
    margin-bottom: 30px;
  }

  #mockupCanvas {
    max-width: 100%;
    height: auto;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
  }

  .loading {
    text-align: center;
    padding: 40px;
    color: #667eea;
    font-size: 1.2em;
  }

  .spinner {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #667eea;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 1s linear infinite;
    margin: 20px auto;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .controls {
    display: flex;
    gap: 20px;
    justify-content: center;
    flex-wrap: wrap;
    margin-bottom: 30px;
  }

  .control-group {
    text-align: center;
  }

  .control-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 600;
    color: #333;
  }

  .control-group input[type="range"] {
    width: 200px;
  }

  .control-group input[type="number"] {
    width: 80px;
    padding: 5px;
    border: 2px solid #667eea;
    border-radius: 5px;
    text-align: center;
  }

  .action-buttons {
    display: flex;
    gap: 20px;
    justify-content: center;
    flex-wrap: wrap;
  }

  .btn-primary {
    padding: 15px 40px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 10px;
    font-size: 1.2em;
    font-weight: 700;
    cursor: pointer;
  }

  .btn-secondary {
    padding: 15px 40px;
    background: #666;
    color: white;
    border: none;
    border-radius: 10px;
    font-size: 1.2em;
    font-weight: 700;
    cursor: pointer;
  }

  .btn-primary:hover, .btn-secondary:hover {
    opacity: 0.9;
  }

  @media (max-width: 768px) {
    .controls {
      flex-direction: column;
    }
    .control-group input[type="range"] {
      width: 100%;
    }
  }
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>Preview Your Iconic Dog on Products</h1>
    <p>Choose a product and see a realistic preview!</p>
  </div>

  <!-- Your Generated Image -->
  <div class="your-image-section">
    <h2>Your Generated Iconic Dog:</h2>
    <img id="yourImage" alt="Your iconic dog" crossorigin="anonymous">
    <p id="poseName" style="margin-top: 10px; font-size: 1.2em;"></p>
  </div>

  <!-- Product Selection -->
  <h2 style="margin-bottom: 20px; text-align: center;">Choose a Product:</h2>
  <div class="products-grid" id="productsGrid">
    <!-- Will be populated by JavaScript -->
  </div>

  <!-- Product Preview -->
  <div class="preview-section" id="previewSection">
    <h2 style="margin-bottom: 20px; text-align: center;">Your Product Preview:</h2>

    <div id="loadingMockup" class="loading" style="display: none;">
      <div class="spinner"></div>
      <p>Generating your product mockup...</p>
    </div>

    <div class="mockup-preview" id="mockupPreview">
      <canvas id="mockupCanvas" width="800" height="800"></canvas>
      <p style="color: #667eea; margin-top: 15px; font-style: italic;">This is how your product will look!</p>
    </div>

    <!-- Controls -->
    <div class="controls">
      <div class="control-group">
        <label>Image Size on Product:</label>
        <input type="range" id="sizeSlider" min="50" max="100" value="80" onchange="updateMockup()">
        <input type="number" id="sizeInput" min="50" max="100" value="80" onchange="syncSize()">%
      </div>
      <div class="control-group">
        <label>Text on Product:</label>
        <input type="text" id="customText" placeholder="Enter text (optional)" onchange="updateMockup()"
          style="width: 250px; padding: 8px; font-size: 1em; border: 2px solid #667eea; border-radius: 5px; text-align: center;">
      </div>
    </div>

    <div class="action-buttons">
      <button class="btn-secondary" onclick="resetSize()">Reset</button>
      <button class="btn-primary" onclick="addToCart()">Add to Cart - <span id="selectedPrice"></span></button>
    </div>
  </div>
</div>

<script>
  // Get URL parameters
  const urlParams = new URLSearchParams(window.location.search);
  const generatedImageUrl = urlParams.get('image');
  const poseName = urlParams.get('pose') || 'Iconic Dog';
  const dogName = urlParams.get('name') || '';

  let products = [];
  let selectedProduct = null;
  let dogImage = new Image();
  let canvas = document.getElementById('mockupCanvas');
  let ctx = canvas.getContext('2d');

  // Set the generated image
  if (generatedImageUrl) {
    document.getElementById('yourImage').src = generatedImageUrl;
    document.getElementById('poseName').textContent = poseName;

    // Load dog image for canvas
    dogImage.crossOrigin = 'anonymous';
    dogImage.src = generatedImageUrl;

    // Set initial custom text value
    if (dogName) {
      document.getElementById('customText').value = dogName;
    }
  } else {
    alert('No image found! Please generate an image first.');
    window.location.href = '/shopify-test.html';
  }

  // Load products
  async function loadProducts() {
    try {
      const response = await fetch('/products-catalog.json');
      const data = await response.json();
      products = data.products;
      displayProducts();
    } catch (error) {
      console.error('Error loading products:', error);
      alert('Error loading products. Please refresh the page.');
    }
  }

  // Display products
  function displayProducts() {
    const grid = document.getElementById('productsGrid');
    grid.innerHTML = '';

    products.forEach(product => {
      const card = document.createElement('div');
      card.className = 'product-card';
      card.onclick = () => selectProduct(product);
      card.innerHTML = `
        <div class="product-name">${product.name}</div>
        <div class="product-price">${product.price}</div>
        <button class="select-btn">Preview on This Product</button>
      `;
      grid.appendChild(card);
    });
  }

  // Select product and generate mockup
  async function selectProduct(product) {
    selectedProduct = product;

    // Update UI
    document.querySelectorAll('.product-card').forEach(card => card.classList.remove('selected'));
    event.currentTarget.classList.add('selected');

    // Show preview section
    document.getElementById('previewSection').classList.add('active');
    document.getElementById('selectedPrice').textContent = product.price;

    // Scroll to preview
    document.getElementById('previewSection').scrollIntoView({ behavior: 'smooth' });

    // Generate mockup
    await generateMockup(product);
  }

  // Generate realistic product mockup using Canvas
  async function generateMockup(product) {
    document.getElementById('loadingMockup').style.display = 'block';
    document.getElementById('mockupPreview').style.display = 'none';

    try {
      // Wait for dog image to load
      await new Promise((resolve, reject) => {
        if (dogImage.complete) {
          resolve();
        } else {
          dogImage.onload = resolve;
          dogImage.onerror = reject;
        }
      });

      // Draw mockup
      await updateMockup();

      document.getElementById('loadingMockup').style.display = 'none';
      document.getElementById('mockupPreview').style.display = 'block';

    } catch (error) {
      console.error('Error generating mockup:', error);
      alert('Error generating mockup. Please try again.');
      document.getElementById('loadingMockup').style.display = 'none';
    }
  }

  // Update mockup based on size
  async function updateMockup() {
    if (!selectedProduct || !dogImage.complete) return;

    const size = parseInt(document.getElementById('sizeInput').value) / 100;

    // Clear canvas
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // Set canvas background
    ctx.fillStyle = '#f5f5f5';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Calculate image dimensions
    const maxWidth = canvas.width * size;
    const maxHeight = canvas.height * size;

    let drawWidth, drawHeight;
    const imgAspect = dogImage.width / dogImage.height;

    if (imgAspect > 1) {
      drawWidth = maxWidth;
      drawHeight = maxWidth / imgAspect;
    } else {
      drawHeight = maxHeight;
      drawWidth = maxHeight * imgAspect;
    }

    // Center the image
    const x = (canvas.width - drawWidth) / 2;
    const y = (canvas.height - drawHeight) / 2;

    // Draw the dog image
    ctx.drawImage(dogImage, x, y, drawWidth, drawHeight);

    // Add product-specific overlay effects
    if (selectedProduct.id === 'blanket') {
      // Add soft texture overlay for blanket
      ctx.globalAlpha = 0.1;
      ctx.fillStyle = '#fff';
      for (let i = 0; i < 50; i++) {
        ctx.fillRect(Math.random() * canvas.width, Math.random() * canvas.height, 2, 2);
      }
      ctx.globalAlpha = 1.0;
    }

    // Add custom text below image (dog name)
    const customText = document.getElementById('customText').value;
    if (customText) {
      // Position text below the dog image
      const textY = y + drawHeight + 60;

      // Add background for text
      ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
      ctx.fillRect(0, textY - 50, canvas.width, 80);

      // Draw text
      ctx.fillStyle = '#333';
      ctx.font = 'bold 48px Arial';
      ctx.textAlign = 'center';
      ctx.fillText(customText, canvas.width / 2, textY);
    }

    // Add product label at bottom
    ctx.fillStyle = 'rgba(102, 126, 234, 0.9)';
    ctx.fillRect(20, canvas.height - 60, canvas.width - 40, 40);
    ctx.fillStyle = 'white';
    ctx.font = 'bold 20px Arial';
    ctx.textAlign = 'center';
    ctx.fillText(selectedProduct.name, canvas.width / 2, canvas.height - 30);
  }

  // Sync size between slider and input
  function syncSize() {
    const value = document.getElementById('sizeInput').value;
    document.getElementById('sizeSlider').value = value;
    updateMockup();
  }

  document.getElementById('sizeSlider').addEventListener('input', (e) => {
    document.getElementById('sizeInput').value = e.target.value;
    updateMockup();
  });

  // Reset size
  function resetSize() {
    document.getElementById('sizeSlider').value = 80;
    document.getElementById('sizeInput').value = 80;
    updateMockup();
  }

  // Add to cart
  function addToCart() {
    if (!selectedProduct) {
      alert('Please select a product first!');
      return;
    }

    const size = document.getElementById('sizeInput').value;
    const customText = document.getElementById('customText').value;
    const productUrl = `https://alldogsrockshop.com/products/${selectedProduct.handle}?image=${encodeURIComponent(generatedImageUrl)}&pose=${encodeURIComponent(poseName)}&size=${size}&text=${encodeURIComponent(customText)}`;

    alert(`ðŸŽ‰ Taking you to checkout!\n\nYour custom ${poseName} image${customText ? ' with "' + customText + '"' : ''} will be added to the ${selectedProduct.name}.`);
    window.location.href = productUrl;
  }

  // Load products on page load
  loadProducts();
</script>

</body>
</html>
