<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Custom Prompt API</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    h1 {
      text-align: center;
      color: #667eea;
      margin-bottom: 10px;
      font-size: 32px;
    }
    .subtitle {
      text-align: center;
      color: #666;
      margin-bottom: 30px;
      font-size: 16px;
    }
    .upload-zone {
      border: 3px dashed #ddd;
      border-radius: 15px;
      padding: 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      background: #fafafa;
      margin-bottom: 20px;
    }
    .upload-zone:hover {
      border-color: #667eea;
      background: #f0f4ff;
    }
    .upload-zone.has-image {
      border-color: #4caf50;
      background: #f1f8f4;
    }
    .icon {
      font-size: 48px;
      margin-bottom: 10px;
    }
    .preview {
      display: none;
      margin: 20px 0;
      text-align: center;
    }
    .preview img {
      max-width: 100%;
      max-height: 300px;
      border-radius: 15px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    input[type="text"] {
      width: 100%;
      padding: 15px 20px;
      border: 2px solid #ddd;
      border-radius: 10px;
      font-size: 16px;
      margin-bottom: 20px;
      transition: border-color 0.3s;
    }
    input[type="text"]:focus {
      outline: none;
      border-color: #667eea;
    }
    button {
      width: 100%;
      padding: 18px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }
    button:hover:not(:disabled) {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .loading {
      display: none;
      text-align: center;
      margin: 30px 0;
    }
    .spinner {
      width: 60px;
      height: 60px;
      border: 6px solid #f3f3f3;
      border-top: 6px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .status {
      font-size: 16px;
      color: #666;
      margin-top: 10px;
    }
    .result {
      display: none;
      margin-top: 30px;
      text-align: center;
    }
    .result img {
      max-width: 100%;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      margin-top: 20px;
    }
    .error {
      display: none;
      background: #fee;
      border: 2px solid #fcc;
      border-radius: 10px;
      padding: 20px;
      margin-top: 20px;
      color: #c33;
    }
    .success {
      color: #4caf50;
      font-weight: bold;
    }
    .api-info {
      background: #f0f4ff;
      border-left: 4px solid #667eea;
      padding: 15px;
      margin: 20px 0;
      border-radius: 8px;
      font-size: 14px;
    }
    .api-info code {
      background: #e8ecff;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üêï Test Custom Prompt API</h1>
    <p class="subtitle">Upload your dog's photo and describe any scene!</p>

    <div class="api-info">
      <strong>Testing:</strong> <code>POST /api/app-proxy/generate</code><br>
      <strong>Format:</strong> <code>{ prompt, image }</code>
    </div>

    <div class="upload-zone" id="uploadZone">
      <div class="icon">üì∑</div>
      <h3>Click to Upload Your Dog's Photo</h3>
      <p style="color: #999; margin-top: 10px;">Supports JPG, PNG</p>
      <input type="file" id="fileInput" accept="image/*" style="display: none;">
    </div>

    <div class="preview" id="preview">
      <h4>Your Photo:</h4>
      <img id="previewImg" alt="Preview">
    </div>

    <input
      type="text"
      id="promptInput"
      placeholder="Describe your vision (e.g., my dog as a superhero flying over the city)"
      disabled
    >

    <button id="generateBtn" disabled>Generate AI Image ‚ú®</button>

    <div class="loading" id="loading">
      <div class="spinner"></div>
      <p class="status" id="status">Preparing your custom artwork...</p>
      <p style="color: #999; font-size: 14px; margin-top: 10px;">This takes 60-90 seconds</p>
    </div>

    <div class="error" id="error"></div>

    <div class="result" id="result">
      <h3 class="success">‚úÖ Success!</h3>
      <img id="resultImg" alt="Generated Image">
      <p style="margin-top: 20px; color: #666;">
        <strong>Your custom AI-generated artwork is ready!</strong>
      </p>
    </div>
  </div>

  <script>
    const API_URL = 'https://all-dogs-rock-api-v2.vercel.app/api/app-proxy/generate';

    let uploadedImage = null;

    const uploadZone = document.getElementById('uploadZone');
    const fileInput = document.getElementById('fileInput');
    const preview = document.getElementById('preview');
    const previewImg = document.getElementById('previewImg');
    const promptInput = document.getElementById('promptInput');
    const generateBtn = document.getElementById('generateBtn');
    const loading = document.getElementById('loading');
    const status = document.getElementById('status');
    const error = document.getElementById('error');
    const result = document.getElementById('result');
    const resultImg = document.getElementById('resultImg');

    uploadZone.onclick = () => fileInput.click();

    fileInput.onchange = async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (ev) => {
        const img = new Image();
        img.onload = () => {
          // Resize image
          const MAX_SIZE = 1024;
          let width = img.width;
          let height = img.height;

          if (width > height && width > MAX_SIZE) {
            height = (height * MAX_SIZE) / width;
            width = MAX_SIZE;
          } else if (height > MAX_SIZE) {
            width = (width * MAX_SIZE) / height;
            height = MAX_SIZE;
          }

          const canvas = document.createElement('canvas');
          canvas.width = width;
          canvas.height = height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, width, height);

          uploadedImage = canvas.toDataURL('image/jpeg', 0.8);

          // Show preview
          previewImg.src = uploadedImage;
          preview.style.display = 'block';
          uploadZone.classList.add('has-image');
          uploadZone.querySelector('h3').textContent = '‚úÖ Photo Uploaded!';

          // Enable inputs
          promptInput.disabled = false;
          promptInput.focus();
          checkFormReady();
        };
        img.src = ev.target.result;
      };
      reader.readAsDataURL(file);
    };

    promptInput.oninput = checkFormReady;

    function checkFormReady() {
      const hasImage = !!uploadedImage;
      const hasPrompt = promptInput.value.trim().length >= 5;
      generateBtn.disabled = !(hasImage && hasPrompt);
    }

    generateBtn.onclick = async () => {
      if (!uploadedImage || !promptInput.value.trim()) {
        showError('Please upload a photo and enter a prompt');
        return;
      }

      // Hide previous results
      result.style.display = 'none';
      error.style.display = 'none';

      // Show loading
      loading.style.display = 'block';
      generateBtn.disabled = true;

      updateStatus('Connecting to AI server...');

      try {
        updateStatus('Sending your photo and prompt...');

        const response = await fetch(API_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            prompt: promptInput.value,
            image: uploadedImage,
            premium: false
          })
        });

        updateStatus('AI is generating your artwork...');

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || errorData.details || `HTTP ${response.status}`);
        }

        const data = await response.json();

        updateStatus('Processing results...');

        if (data.success && (data.imageUrl || data.images)) {
          const imageUrl = data.imageUrl || data.images[0];

          // Show result
          resultImg.src = imageUrl;
          result.style.display = 'block';
          loading.style.display = 'none';

          console.log('‚úÖ SUCCESS!', data);
        } else {
          throw new Error(data.error || 'Generation failed');
        }

      } catch (err) {
        console.error('‚ùå Error:', err);
        showError(`Failed to generate image: ${err.message}`);
        loading.style.display = 'none';
        generateBtn.disabled = false;
      }
    };

    function updateStatus(text) {
      status.textContent = text;
    }

    function showError(message) {
      error.textContent = message;
      error.style.display = 'block';
      setTimeout(() => {
        error.style.display = 'none';
      }, 5000);
    }
  </script>
</body>
</html>
