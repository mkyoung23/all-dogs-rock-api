<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Create Your Iconic Dog - All Dogs Rock Shop</title>
  <meta name="description" content="Transform your dog into a legendary icon in 4 easy steps!">

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
    }

    .stage-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 40px 20px;
    }

    .stage {
      display: none;
    }

    .stage.active {
      display: block;
    }

    .stage-header {
      text-align: center;
      padding: 40px 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 20px;
      color: white;
      margin-bottom: 40px;
    }

    .stage-header h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
    }

    .stage-header p {
      font-size: 1.2em;
      opacity: 0.95;
    }

    .upload-zone {
      border: 3px dashed #667eea;
      border-radius: 15px;
      padding: 60px 20px;
      text-align: center;
      background: #f8f9ff;
      margin-bottom: 20px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .upload-zone:hover {
      border-color: #764ba2;
      background: #f0f2ff;
    }

    .upload-zone.has-images {
      border-style: solid;
      border-color: #28a745;
    }

    .photo-previews {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 20px;
      margin: 20px 0;
    }

    .photo-preview {
      position: relative;
      border-radius: 10px;
      overflow: hidden;
    }

    .photo-preview img {
      width: 100%;
      height: 200px;
      object-fit: cover;
    }

    .remove-photo {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      cursor: pointer;
      font-weight: bold;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 18px 50px;
      border-radius: 50px;
      font-size: 1.2em;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
      display: block;
      margin: 30px auto;
    }

    .btn-primary:hover {
      transform: scale(1.05);
      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .templates-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 30px;
      margin-bottom: 30px;
    }

    .template-card {
      background: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      text-align: center;
      transition: transform 0.3s;
    }

    .template-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 40px rgba(0,0,0,0.15);
    }

    .template-image {
      width: 100%;
      height: 250px;
      object-fit: cover;
      border-radius: 10px;
      margin-bottom: 15px;
    }

    .template-card h2 {
      font-size: 1.5em;
      margin-bottom: 10px;
      color: #333;
    }

    .template-card p {
      color: #666;
      font-size: 1em;
      margin-bottom: 20px;
      min-height: 60px;
    }

    .custom-options {
      background: #f8f9ff;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 15px;
    }

    .custom-options label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: #333;
      text-align: left;
    }

    .custom-options select,
    .custom-options input {
      width: 100%;
      padding: 10px;
      border: 2px solid #667eea;
      border-radius: 8px;
      font-size: 1em;
      margin-bottom: 10px;
    }

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .loading-overlay.active {
      display: flex;
    }

    .loading-content {
      background: white;
      padding: 50px;
      border-radius: 20px;
      text-align: center;
      max-width: 500px;
    }

    .spinner {
      border: 6px solid #f3f3f3;
      border-top: 6px solid #667eea;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .result-container {
      text-align: center;
    }

    .result-image {
      max-width: 100%;
      border-radius: 15px;
      margin: 20px 0;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
      border: none;
      padding: 15px 40px;
      border-radius: 50px;
      font-size: 1.1em;
      font-weight: 600;
      cursor: pointer;
      margin: 10px;
    }

    .btn-success {
      background: #28a745;
      color: white;
      border: none;
      padding: 18px 50px;
      border-radius: 50px;
      font-size: 1.2em;
      font-weight: 700;
      cursor: pointer;
      margin: 10px;
    }

    /* Product Selection Styles */
    .products-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 40px;
      margin: 40px 0;
    }

    .product-card {
      background: white;
      border-radius: 20px;
      padding: 40px 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      text-align: center;
      transition: all 0.3s;
      border: 3px solid transparent;
    }

    .product-card:hover {
      transform: translateY(-10px);
      box-shadow: 0 20px 50px rgba(0,0,0,0.2);
      border-color: #667eea;
    }

    .product-card h3 {
      font-size: 1.8em;
      margin-bottom: 15px;
      color: #333;
    }

    .product-card .product-description {
      color: #666;
      font-size: 1.1em;
      margin-bottom: 20px;
      line-height: 1.6;
    }

    .product-price {
      font-size: 2em;
      font-weight: 900;
      color: #667eea;
      margin-bottom: 25px;
    }

    .product-features {
      text-align: left;
      margin-bottom: 25px;
      padding: 0 20px;
    }

    .product-features li {
      color: #666;
      font-size: 1em;
      margin-bottom: 10px;
      padding-left: 25px;
      position: relative;
    }

    .product-features li:before {
      content: "✓";
      position: absolute;
      left: 0;
      color: #28a745;
      font-weight: bold;
    }

    .generated-preview {
      max-width: 400px;
      margin: 0 auto 40px;
      padding: 20px;
      background: #f8f9ff;
      border-radius: 15px;
    }

    .generated-preview img {
      max-width: 100%;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    .generated-preview p {
      margin-top: 15px;
      color: #666;
      font-size: 1em;
    }

    /* Product Mockup Editor Styles */
    .product-tabs {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin: 30px 0;
      flex-wrap: wrap;
    }

    .product-tab {
      background: white;
      color: #667eea;
      border: 3px solid #667eea;
      padding: 15px 40px;
      border-radius: 50px;
      font-size: 1.1em;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
    }

    .product-tab:hover {
      background: #f0f0ff;
    }

    .product-tab.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-color: #764ba2;
    }

    .mockup-editor-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 40px;
      margin: 40px 0;
      max-width: 1200px;
      margin-left: auto;
      margin-right: auto;
    }

    @media (max-width: 900px) {
      .mockup-editor-container {
        grid-template-columns: 1fr;
      }
    }

    .mockup-preview-area {
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    }

    #productMockupCanvas {
      max-width: 100%;
      height: auto;
      border-radius: 10px;
      display: block;
      margin: 0 auto;
    }

    .editor-controls {
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    }

    .editor-controls h3 {
      font-size: 1.6em;
      margin-bottom: 10px;
      color: #333;
    }

    .control-group {
      margin: 25px 0;
    }

    .control-group label {
      display: flex;
      justify-content: space-between;
      font-weight: 600;
      color: #555;
      margin-bottom: 10px;
      font-size: 1em;
    }

    .control-group label span:last-child {
      color: #667eea;
      font-weight: 700;
    }

    .control-group input[type="range"] {
      width: 100%;
      height: 8px;
      border-radius: 5px;
      background: #e0e0e0;
      outline: none;
      -webkit-appearance: none;
    }

    .control-group input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      cursor: pointer;
      box-shadow: 0 2px 10px rgba(102, 126, 234, 0.5);
    }

    .control-group input[type="range"]::-moz-range-thumb {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      cursor: pointer;
      border: none;
      box-shadow: 0 2px 10px rgba(102, 126, 234, 0.5);
    }

    .product-details-section {
      max-width: 800px;
      margin: 40px auto;
    }

    .product-details {
      display: none;
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
      text-align: center;
    }

    .product-details.active {
      display: block;
    }

    .product-details h3 {
      font-size: 2em;
      margin-bottom: 20px;
      color: #333;
    }

    .btn-lg {
      font-size: 1.4em;
      padding: 20px 60px;
    }
  </style>
</head>
<body>
  <div class="stage-container">
    <!-- STAGE 1: Upload Dog Photos -->
    <div id="stage1" class="stage active">
      <div class="stage-header">
        <h1>Step 1: Upload Your Dog's Photos</h1>
        <p>Upload 1-3 photos of your dog from different angles so we can capture their features perfectly</p>
      </div>

      <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
        <p style="font-size: 1.3em; margin-bottom: 10px;">Click to upload or drag & drop</p>
        <p style="color: #666;">JPG or PNG • 1-3 photos recommended • Auto-optimized for best quality</p>
      </div>

      <input type="file" id="fileInput" multiple accept="image/jpeg,image/png,image/jpg" style="display: none;" onchange="handleFileUpload(event)">

      <div id="photoPreviews" class="photo-previews"></div>

      <button class="btn-primary" id="continueBtn1" onclick="goToStage2()" disabled>
        Continue to Choose Template
      </button>
    </div>

    <!-- STAGE 2: Choose Template -->
    <div id="stage2" class="stage">
      <div class="stage-header">
        <h1>Step 2: Choose Your Iconic Pose</h1>
        <p>Select which famous image you want your dog in. See real AI-generated examples below!</p>
      </div>

      <div class="templates-grid">
        <!-- Washington Crossing Delaware -->
        <div class="template-card">
          <img src="/images/examples/george-washington.svg" class="template-image" alt="Washington Crossing Delaware">
          <h2>Washington Crossing the Delaware</h2>
          <p>Your dog as General Washington, heroically leading troops across the icy Delaware River!</p>
          <p style="font-size: 0.85em; color: #999; font-style: italic; margin-bottom: 15px;">Example: See what your dog could look like!</p>
          <button class="btn-primary" onclick="selectPose('washington-crossing')">
            Transform My Dog
          </button>
        </div>

        <!-- Rocky at Steps -->
        <div class="template-card">
          <img src="/images/examples/rocky.svg" class="template-image" alt="Rocky">
          <h2>Rocky at the Steps</h2>
          <p>Your dog as Rocky Balboa with arms raised triumphantly at the Philadelphia Museum steps!</p>
          <p style="font-size: 0.85em; color: #999; font-style: italic; margin-bottom: 15px;">Example: See what your dog could look like!</p>
          <button class="btn-primary" onclick="selectPose('rocky-statue')">
            Transform My Dog
          </button>
        </div>

        <!-- Babe Ruth -->
        <div class="template-card">
          <img src="/images/examples/babe-ruth.svg" class="template-image" alt="Babe Ruth">
          <h2>Babe Ruth Called Shot</h2>
          <p>Your dog as Babe Ruth pointing to the outfield in the legendary called shot moment!</p>
          <p style="font-size: 0.85em; color: #999; font-style: italic; margin-bottom: 15px;">Example: See what your dog could look like!</p>
          <button class="btn-primary" onclick="selectPose('babe-ruth-called-shot')">
            Transform My Dog
          </button>
        </div>

        <!-- Presidential Speech -->
        <div class="template-card">
          <img src="/images/examples/presidential-speech.svg" class="template-image" alt="Presidential Speech">
          <h2>Presidential Inaugural Speech</h2>
          <p>Your dog as the President giving their inaugural address at the podium with American flags!</p>
          <p style="font-size: 0.85em; color: #999; font-style: italic; margin-bottom: 15px;">Example: See what your dog could look like!</p>
          <button class="btn-primary" onclick="selectPose('presidential-speech')">
            Transform My Dog
          </button>
        </div>

        <!-- NFL Team Photo -->
        <div class="template-card">
          <img src="/images/examples/nfl-team.svg" class="template-image" alt="NFL Team">
          <h2>NFL Team Photo</h2>
          <p>Your dog as an NFL player! Pick your team and jersey number below:</p>
          <p style="font-size: 0.85em; color: #999; font-style: italic; margin-bottom: 15px;">Example: See what your dog could look like!</p>

          <div class="custom-options">
            <label for="nflTeam">Select NFL Team:</label>
            <select id="nflTeam">
              <option value="Kansas City Chiefs">Kansas City Chiefs</option>
              <option value="Philadelphia Eagles">Philadelphia Eagles</option>
              <option value="Dallas Cowboys">Dallas Cowboys</option>
              <option value="San Francisco 49ers">San Francisco 49ers</option>
              <option value="Buffalo Bills">Buffalo Bills</option>
              <option value="Cincinnati Bengals">Cincinnati Bengals</option>
              <option value="Green Bay Packers">Green Bay Packers</option>
              <option value="New England Patriots">New England Patriots</option>
              <option value="Pittsburgh Steelers">Pittsburgh Steelers</option>
              <option value="Seattle Seahawks">Seattle Seahawks</option>
              <option value="Miami Dolphins">Miami Dolphins</option>
              <option value="Los Angeles Rams">Los Angeles Rams</option>
              <option value="Baltimore Ravens">Baltimore Ravens</option>
              <option value="Las Vegas Raiders">Las Vegas Raiders</option>
              <option value="Minnesota Vikings">Minnesota Vikings</option>
              <option value="Denver Broncos">Denver Broncos</option>
            </select>

            <label for="jerseyNumber">Jersey Number (0-99):</label>
            <input type="number" id="jerseyNumber" min="0" max="99" value="15">
          </div>

          <button class="btn-primary" onclick="selectNFLPose()">
            Transform My Dog
          </button>
        </div>

        <!-- Santa Paws -->
        <div class="template-card">
          <img src="/images/examples/santa-claus.svg" class="template-image" alt="Santa Paws">
          <h2>Santa Paws</h2>
          <p>Your dog as Santa Claus spreading holiday cheer with gifts and festive Christmas decorations!</p>
          <p style="font-size: 0.85em; color: #999; font-style: italic; margin-bottom: 15px;">Example: See what your dog could look like!</p>
          <button class="btn-primary" onclick="selectPose('santa-claus')">
            Transform My Dog
          </button>
        </div>
      </div>

      <button class="btn-secondary" onclick="goToStage1()">Back to Upload Photos</button>
    </div>

    <!-- STAGE 3: Generating & Result -->
    <div id="stage3" class="stage">
      <div class="stage-header">
        <h1>Step 3: Your Iconic Dog is Ready!</h1>
        <p>Here's your dog transformed into an icon</p>
      </div>

      <div class="result-container" id="resultContainer">
        <img id="resultImage" class="result-image" alt="Your iconic dog">
        <div style="margin-top: 30px;">
          <button class="btn-success" onclick="goToStage4()">Choose Your Product</button>
          <button class="btn-secondary" onclick="startOver()">Start Over</button>
        </div>
      </div>
    </div>

    <!-- STAGE 4: Choose Product with Live Mockup Editor -->
    <div id="stage4" class="stage">
      <div class="stage-header">
        <h1>Step 4: Preview & Choose Your Product</h1>
        <p>See your dog on the product and adjust the fit perfectly!</p>
      </div>

      <!-- Product Tabs -->
      <div class="product-tabs">
        <button class="product-tab active" onclick="switchProduct('poster')" id="tab-poster">
          Poster $29.99
        </button>
        <button class="product-tab" onclick="switchProduct('tshirt')" id="tab-tshirt">
          T-Shirt $44.99
        </button>
        <button class="product-tab" onclick="switchProduct('canvas')" id="tab-canvas">
          Canvas $79.99
        </button>
      </div>

      <!-- Live Product Mockup -->
      <div class="mockup-editor-container">
        <div class="mockup-preview-area">
          <canvas id="productMockupCanvas" width="600" height="600"></canvas>
          <p style="text-align: center; color: #666; margin-top: 15px;">
            <strong>Live Preview:</strong> Adjust the fit below
          </p>
        </div>

        <!-- Image Editor Controls -->
        <div class="editor-controls">
          <h3>Adjust Your Image Fit</h3>
          <p style="color: #666; margin-bottom: 20px;">Fine-tune how your dog appears on the product</p>

          <div class="control-group">
            <label>
              <span>Zoom / Scale</span>
              <span id="scaleValue">100%</span>
            </label>
            <input type="range" id="scaleSlider" min="50" max="200" value="100" oninput="updateMockup()">
          </div>

          <div class="control-group">
            <label>
              <span>Position X (Left/Right)</span>
              <span id="posXValue">Center</span>
            </label>
            <input type="range" id="posXSlider" min="-100" max="100" value="0" oninput="updateMockup()">
          </div>

          <div class="control-group">
            <label>
              <span>Position Y (Up/Down)</span>
              <span id="posYValue">Center</span>
            </label>
            <input type="range" id="posYSlider" min="-100" max="100" value="0" oninput="updateMockup()">
          </div>

          <div class="control-group">
            <label>
              <span>Rotation</span>
              <span id="rotationValue">0°</span>
            </label>
            <input type="range" id="rotationSlider" min="-45" max="45" value="0" oninput="updateMockup()">
          </div>

          <button class="btn-secondary" onclick="resetEditor()" style="width: 100%; margin-top: 15px;">
            Reset to Default
          </button>
        </div>
      </div>

      <!-- Product Details -->
      <div class="product-details-section">
        <div id="product-details-poster" class="product-details active">
          <h3>12x18" Poster Print - $29.99</h3>
          <ul class="product-features">
            <li>12" x 18" premium poster</li>
            <li>High-quality matte finish</li>
            <li>Acid-free archival paper</li>
            <li>Vibrant, long-lasting colors</li>
            <li>Ready to frame & display</li>
          </ul>
          <button class="btn-success btn-lg" onclick="addToCartPoster()">
            Add Poster to Cart - $29.99
          </button>
        </div>

        <div id="product-details-tshirt" class="product-details">
          <h3>Premium T-Shirt - $44.99</h3>
          <ul class="product-features">
            <li>Unisex sizing (S-2XL)</li>
            <li>Premium cotton blend</li>
            <li>Vibrant, durable print</li>
            <li>Pre-shrunk & soft</li>
            <li>Conversation starter!</li>
          </ul>
          <button class="btn-success btn-lg" onclick="addToCartTShirt()">
            Add T-Shirt to Cart - $44.99
          </button>
        </div>

        <div id="product-details-canvas" class="product-details">
          <h3>16x20" Canvas Print - $79.99</h3>
          <ul class="product-features">
            <li>16" x 20" stretched canvas</li>
            <li>Museum-quality cotton blend</li>
            <li>1.5" deep wood frame</li>
            <li>Ready to hang</li>
            <li>Professional gallery look</li>
          </ul>
          <button class="btn-success btn-lg" onclick="addToCartCanvas()">
            Add Canvas to Cart - $79.99
          </button>
        </div>
      </div>

      <div style="text-align: center; margin-top: 40px;">
        <button class="btn-secondary" onclick="goToStage3()">Back to View Image</button>
        <button class="btn-secondary" onclick="startOver()">Start Over</button>
      </div>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="loading-content">
      <div class="spinner"></div>
      <h2 style="margin-bottom: 15px;">Creating Your Masterpiece...</h2>
      <p id="loadingText">Analyzing your dog's features...</p>
      <p style="color: #666; margin-top: 10px;">This takes about 10-15 seconds</p>
    </div>
  </div>

  <script>
    const API_BASE = window.location.origin;
    let uploadedPhotos = [];
    let selectedPoseId = '';
    let finalImageUrl = '';
    let customFields = {};

    // Compress image to ensure it works on all devices/networks
    // Quality kept high (0.92) to maintain AI generation quality
    async function compressImage(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();

        reader.onload = (e) => {
          const img = new Image();

          img.onload = () => {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;

            // Resize if too large (keep aspect ratio)
            // Max 2048px - high enough for excellent AI quality
            const maxDimension = 2048;
            if (width > maxDimension || height > maxDimension) {
              if (width > height) {
                height = (height / width) * maxDimension;
                width = maxDimension;
              } else {
                width = (width / height) * maxDimension;
                height = maxDimension;
              }
            }

            canvas.width = width;
            canvas.height = height;

            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);

            // High quality JPEG (0.92) to maintain AI generation quality
            // This balances file size with image quality
            canvas.toBlob(
              (blob) => {
                if (blob) {
                  resolve(blob);
                } else {
                  reject(new Error('Compression failed'));
                }
              },
              'image/jpeg',
              0.92
            );
          };

          img.onerror = () => reject(new Error('Failed to load image'));
          img.src = e.target.result;
        };

        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsDataURL(file);
      });
    }

    // Handle file upload with compression
    async function handleFileUpload(event) {
      const files = Array.from(event.target.files);

      // Disable button during processing
      const btn = document.getElementById('continueBtn1');
      btn.textContent = 'Processing photos...';
      btn.disabled = true;

      try {
        for (const file of files) {
          if (uploadedPhotos.length >= 3) {
            alert('Maximum 3 photos allowed');
            break;
          }

          // Validate file type
          if (!file.type.startsWith('image/')) {
            alert(file.name + ' is not an image file');
            continue;
          }

          // Validate file size before compression (max 50MB)
          if (file.size > 50 * 1024 * 1024) {
            alert(file.name + ' is too large (max 50MB). Please choose a smaller photo.');
            continue;
          }

          // Compress image for reliable upload
          const compressedBlob = await compressImage(file);

          // Convert compressed blob to base64
          const reader = new FileReader();
          const base64Data = await new Promise((resolve, reject) => {
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(compressedBlob);
          });

          // Check compressed size (should be under 3MB)
          const sizeInMB = base64Data.length / 1024 / 1024;
          if (sizeInMB > 3.5) {
            alert(file.name + ' is too large even after compression. Try a different photo.');
            continue;
          }

          uploadedPhotos.push({
            data: base64Data,
            name: file.name
          });
          displayPreviews();
        }

        document.getElementById('uploadZone').classList.add('has-images');
        updateContinueButton();
      } catch (error) {
        console.error('Upload error:', error);
        alert('Failed to process photos: ' + error.message);
      }

      // Re-enable button
      btn.textContent = 'Continue to Choose Template';
      updateContinueButton();
    }

    // Display photo previews
    function displayPreviews() {
      const container = document.getElementById('photoPreviews');
      container.innerHTML = '';

      uploadedPhotos.forEach((photo, index) => {
        const div = document.createElement('div');
        div.className = 'photo-preview';
        div.innerHTML = `
          <img src="${photo.data}" alt="Dog photo ${index + 1}">
          <button class="remove-photo" onclick="removePhoto(${index})">×</button>
        `;
        container.appendChild(div);
      });
    }

    // Remove photo
    function removePhoto(index) {
      uploadedPhotos.splice(index, 1);
      displayPreviews();
      updateContinueButton();

      if (uploadedPhotos.length === 0) {
        document.getElementById('uploadZone').classList.remove('has-images');
      }
    }

    // Update continue button
    function updateContinueButton() {
      const btn = document.getElementById('continueBtn1');
      btn.disabled = uploadedPhotos.length === 0;
    }

    // Navigation functions
    function goToStage1() {
      showStage('stage1');
    }

    function goToStage2() {
      if (uploadedPhotos.length === 0) {
        alert('Please upload at least one photo of your dog');
        return;
      }
      showStage('stage2');
    }

    function goToStage3() {
      showStage('stage3');
    }

    // Product mockup state
    let currentProduct = 'poster';
    let mockupImage = null;
    let imageTransform = {
      scale: 1.0,
      posX: 0,
      posY: 0,
      rotation: 0
    };

    function goToStage4() {
      showStage('stage4');
      // Initialize mockup editor
      initMockupEditor();
    }

    // Initialize the mockup editor
    async function initMockupEditor() {
      // Load the generated image
      mockupImage = new Image();
      mockupImage.crossOrigin = 'anonymous';
      mockupImage.onload = () => {
        renderMockup();
      };
      mockupImage.src = finalImageUrl;

      // Reset to defaults
      currentProduct = 'poster';
      resetEditor();
    }

    // Switch between product types
    function switchProduct(productType) {
      currentProduct = productType;

      // Update tab active states
      document.querySelectorAll('.product-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      document.getElementById(`tab-${productType}`).classList.add('active');

      // Update product details visibility
      document.querySelectorAll('.product-details').forEach(details => {
        details.classList.remove('active');
      });
      document.getElementById(`product-details-${productType}`).classList.add('active');

      // Re-render mockup with new product
      renderMockup();
    }

    // Update mockup when controls change
    function updateMockup() {
      // Get values from sliders
      const scale = parseFloat(document.getElementById('scaleSlider').value) / 100;
      const posX = parseInt(document.getElementById('posXSlider').value);
      const posY = parseInt(document.getElementById('posYSlider').value);
      const rotation = parseInt(document.getElementById('rotationSlider').value);

      // Update state
      imageTransform.scale = scale;
      imageTransform.posX = posX;
      imageTransform.posY = posY;
      imageTransform.rotation = rotation;

      // Update display values
      document.getElementById('scaleValue').textContent = Math.round(scale * 100) + '%';
      document.getElementById('posXValue').textContent = posX === 0 ? 'Center' : (posX > 0 ? `Right +${posX}` : `Left ${posX}`);
      document.getElementById('posYValue').textContent = posY === 0 ? 'Center' : (posY > 0 ? `Down +${posY}` : `Up ${posY}`);
      document.getElementById('rotationValue').textContent = rotation + '°';

      // Re-render
      renderMockup();
    }

    // Reset editor to defaults
    function resetEditor() {
      document.getElementById('scaleSlider').value = 100;
      document.getElementById('posXSlider').value = 0;
      document.getElementById('posYSlider').value = 0;
      document.getElementById('rotationSlider').value = 0;
      imageTransform = { scale: 1.0, posX: 0, posY: 0, rotation: 0 };
      updateMockup();
    }

    // Render the product mockup on canvas
    function renderMockup() {
      if (!mockupImage) return;

      const canvas = document.getElementById('productMockupCanvas');
      const ctx = canvas.getContext('2d');

      // Clear canvas
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // Define product mockup backgrounds and print areas
      const mockups = {
        poster: {
          bg: '#f5f5f5',
          frame: '#8B7355',
          printArea: { x: 150, y: 100, width: 300, height: 400 }
        },
        tshirt: {
          bg: '#e8e8e8',
          shirtColor: '#ffffff',
          printArea: { x: 200, y: 180, width: 200, height: 200 }
        },
        canvas: {
          bg: '#f0f0f0',
          frame: '#654321',
          printArea: { x: 120, y: 100, width: 360, height: 400 }
        }
      };

      const mockup = mockups[currentProduct];

      // Draw background
      ctx.fillStyle = mockup.bg;
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // Draw product-specific mockup
      if (currentProduct === 'poster') {
        // Poster frame
        ctx.fillStyle = mockup.frame;
        ctx.fillRect(130, 80, 340, 440);
        // White inner area
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(150, 100, 300, 400);
      } else if (currentProduct === 'tshirt') {
        // T-shirt shape
        ctx.fillStyle = mockup.shirtColor;
        // Body
        ctx.fillRect(180, 150, 240, 350);
        // Neck
        ctx.beginPath();
        ctx.arc(300, 150, 40, 0, Math.PI * 2);
        ctx.fill();
        // Sleeves
        ctx.fillRect(140, 180, 40, 120);
        ctx.fillRect(420, 180, 40, 120);
        // Outline
        ctx.strokeStyle = '#ddd';
        ctx.lineWidth = 2;
        ctx.strokeRect(180, 150, 240, 350);
      } else if (currentProduct === 'canvas') {
        // Canvas frame (thicker for gallery wrap)
        ctx.fillStyle = mockup.frame;
        ctx.fillRect(100, 80, 400, 440);
        // Canvas surface
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(120, 100, 360, 400);
      }

      // Draw the dog image with transforms
      const printArea = mockup.printArea;

      ctx.save();
      ctx.translate(printArea.x + printArea.width / 2, printArea.y + printArea.height / 2);
      ctx.translate(imageTransform.posX, imageTransform.posY);
      ctx.rotate((imageTransform.rotation * Math.PI) / 180);
      ctx.scale(imageTransform.scale, imageTransform.scale);

      // Calculate aspect-fit dimensions
      const imgAspect = mockupImage.width / mockupImage.height;
      const areaAspect = printArea.width / printArea.height;
      let drawWidth, drawHeight;

      if (imgAspect > areaAspect) {
        drawWidth = printArea.width;
        drawHeight = printArea.width / imgAspect;
      } else {
        drawHeight = printArea.height;
        drawWidth = printArea.height * imgAspect;
      }

      ctx.drawImage(
        mockupImage,
        -drawWidth / 2,
        -drawHeight / 2,
        drawWidth,
        drawHeight
      );

      ctx.restore();

      // Add product label
      ctx.fillStyle = '#333';
      ctx.font = 'bold 18px Arial';
      ctx.textAlign = 'center';
      const labels = {
        poster: '12x18" Poster Print',
        tshirt: 'Premium T-Shirt',
        canvas: '16x20" Canvas Print'
      };
      ctx.fillText(labels[currentProduct], canvas.width / 2, canvas.height - 30);
    }

    // Select pose (regular poses)
    function selectPose(poseId) {
      selectedPoseId = poseId;
      customFields = {};
      generateImage();
    }

    // Select NFL pose with customization
    function selectNFLPose() {
      selectedPoseId = 'nfl-team-photo';
      customFields = {
        team: document.getElementById('nflTeam').value,
        jerseyNumber: parseInt(document.getElementById('jerseyNumber').value)
      };
      generateImage();
    }

    // Generate image
    async function generateImage() {
      showLoading(true);
      updateLoadingText('Analyzing your dog\'s unique features...');

      try {
        const primaryPhoto = uploadedPhotos[0].data;
        updateLoadingText('Placing your dog into the iconic scene...');

        const requestBody = {
          dogPhoto: primaryPhoto,
          poseId: selectedPoseId
        };

        // Add custom fields if they exist (for NFL pose)
        if (Object.keys(customFields).length > 0) {
          requestBody.customFields = customFields;
        }

        const response = await fetch(`${API_BASE}/api/app-proxy/generate`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(requestBody)
        });

        const data = await response.json();
        showLoading(false);

        if (data.success) {
          finalImageUrl = Array.isArray(data.imageUrl) ? data.imageUrl[0] : data.imageUrl;
          document.getElementById('resultImage').src = finalImageUrl;
          showStage('stage3');
        } else {
          alert('Generation failed: ' + (data.error || 'Unknown error'));
        }
      } catch (error) {
        showLoading(false);
        console.error('Error:', error);
        alert('Failed to generate image. Please try again!');
      }
    }

    function showStage(stageId) {
      document.querySelectorAll('.stage').forEach(stage => {
        stage.classList.remove('active');
      });
      document.getElementById(stageId).classList.add('active');
      window.scrollTo(0, 0);
    }

    function showLoading(show) {
      const overlay = document.getElementById('loadingOverlay');
      if (show) {
        overlay.classList.add('active');
      } else {
        overlay.classList.remove('active');
      }
    }

    function updateLoadingText(text) {
      document.getElementById('loadingText').textContent = text;
    }

    // Add to cart functions for each product type
    async function addToCartPoster() {
      await createProductAndCheckout('poster', 'Poster Print', '$29.99');
    }

    async function addToCartTShirt() {
      await createProductAndCheckout('tshirt', 'Premium T-Shirt', '$44.99');
    }

    async function addToCartCanvas() {
      await createProductAndCheckout('canvas', 'Canvas Print', '$79.99');
    }

    // Main function to create Printify product and redirect to checkout
    async function createProductAndCheckout(productTier, productName, price) {
      if (!finalImageUrl) {
        alert('Error: No image found. Please generate an image first.');
        return;
      }

      // Show loading
      showLoading(true);
      updateLoadingText(`Creating your custom ${productName}... This may take 30-60 seconds.`);

      try {
        // Call our create-and-checkout API
        const response = await fetch('/api/create-and-checkout', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            imageUrl: finalImageUrl,
            productTier: productTier,
            poseName: selectedPoseId,
            dogName: 'Your Dog' // Could capture this from user input if you add a form field
          })
        });

        const data = await response.json();
        showLoading(false);

        if (data.success) {
          // Success! Redirect to checkout or product page
          if (data.checkoutUrl) {
            // Direct to checkout (fastest)
            updateLoadingText('Redirecting to checkout...');
            window.location.href = data.checkoutUrl;
          } else if (data.productUrl) {
            // Or go to product page first
            updateLoadingText('Redirecting to product page...');
            window.location.href = data.productUrl;
          } else {
            // Fallback: show success message with product ID
            alert(`Success! Your ${productName} (${price}) has been created!\n\nPrintify Product ID: ${data.printifyProductId}\n\nPlease check your Shopify store to complete the purchase.`);
          }
        } else {
          alert('Failed to create product: ' + (data.error || 'Unknown error.\n\nPlease try again or contact support.'));
        }
      } catch (error) {
        showLoading(false);
        console.error('Error creating product:', error);
        alert('Failed to create product. Please try again or contact support.\n\nError: ' + error.message);
      }
    }

    function startOver() {
      uploadedPhotos = [];
      finalImageUrl = '';
      selectedPoseId = '';
      customFields = {};
      document.getElementById('uploadZone').classList.remove('has-images');
      displayPreviews();
      updateContinueButton();
      goToStage1();
    }

    // Drag and drop support
    const uploadZone = document.getElementById('uploadZone');

    uploadZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadZone.style.borderColor = '#764ba2';
    });

    uploadZone.addEventListener('dragleave', () => {
      uploadZone.style.borderColor = '#667eea';
    });

    uploadZone.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadZone.style.borderColor = '#667eea';

      const files = Array.from(e.dataTransfer.files);
      const imageFiles = files.filter(f => f.type.startsWith('image/'));

      if (imageFiles.length > 0) {
        document.getElementById('fileInput').files = e.dataTransfer.files;
        handleFileUpload({ target: { files: imageFiles } });
      }
    });
  </script>
</body>
</html>
